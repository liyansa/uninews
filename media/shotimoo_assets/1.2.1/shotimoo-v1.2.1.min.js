
var Shotimoo=new Class({elements:[],Implements:[Options,Events],scrollTimeOut:null,options:{parent:'',height:50,width:300,visibleTime:5000,locationVType:'top',locationHType:'right',locationVBase:10,locationHBase:10,notificationsMargin:5,opacityTransitionTime:750,closeRelocationTransitionTime:750,scrollRelocationTransitionTime:500,notificationOpacity:0.95},initialize:function(options){this.options.parent=$(document.body);if(options){if(options.parent)options.parent=$(options.parent);this.setOptions(options);}
var manager=this;this.options.parent.addEvent('scroll',function(){$clear(this.scrollTimeOut);this.scrollTimeOut=(function(){manager._relocateActiveNotifications(manager.TYPE_RELOCATE_SCROLL)}).delay(200);},this);window.addEvent('scroll',function(){$clear(manager.scrollTimeOut);manager.scrollTimeOut=(function(){manager._relocateActiveNotifications(manager.TYPE_RELOCATE_SCROLL)}).delay(200);});this.elements.push(this.createNotificationElement(this.options));},createNotificationElement:function(){var el=new Element('div',{'class':'shotimoo'});el.setStyle(this.options.locationVType,this.options.locationVBase);el.setStyle(this.options.locationHType,this.options.locationHBase);el.adopt(new Element('span',{'class':'shotimootitle'}));el.adopt(new Element('div',{'class':'shotimoomessage'}));el.setStyle('width',this.options.width);el.setStyle('height',this.options.height);el.store('working',false);el.set('tween',{link:'chain',duration:this.options.opacityTransitionTime});el.set('opacity',0);var fx1=new Fx.Tween(el,{property:this.options.locationVType,link:'chain',duration:this.options.closeRelocationTransitionTime});el.store('baseTween',fx1);var fx2=new Fx.Tween(el,{property:this.options.locationVType,link:'chain',duration:this.options.scrollRelocationTransitionTime});el.store('scrollTween',fx2);el.addEvent('click',function(event){event.stop();if(this.options.shSetCookie&&this.options.shId){var shCookie=Cookie.write('shotimoo_clrd_'+this.options.shId,true,{path:'/',duration:1});}
this.close(el);}.bind(this));return el;},show:function(options){var manager=this;var nextBase=this._applyScrollPosition(this.options.locationVBase);var el=this.elements.filter(function(el){var w=el.retrieve('working');if(w){nextBase=el.getStyle(this.options.locationVType).toInt()+el.getSize().y+this.options.notificationsMargin;}
return!w;},this).getLast();if(!el){el=this.createNotificationElement();this.elements.push(el);}
el.setStyle(this.options.locationVType,nextBase);el.store('working',true);if(options.width)el.setStyle('width',options.width);if(options.title){el.getElement('span.shotimootitle').set('html',options.title);}
el.getElement('div.shotimoomessage').set('html',options.message);if(options.customClass)el.addClass(options.customClass);el.getElements('a').addEvent('click',function(event){event.stopPropagation();});this.options.parent.adopt(el);this._checkSize(el);if('hidden'==el.getStyle('visibility'))el.setStyle('visibility','visible');el.get('tween').start('opacity',this.options.notificationOpacity).chain(function(){if((options.sticky)?!options.sticky:true){(function(){manager.close(el);}).delay((options.visibleTime)?options.visibleTime:manager.options.visibleTime,manager);}
manager.fireEvent('show',el);});},close:function(element){var manager=this;var nots=manager.elements;element.get('tween').start('opacity',0).chain(function(){if(nots.length>1){nots.elements=nots.erase(element);element.destroy();}
manager._resetNotificationElement(element);manager._relocateActiveNotifications(manager.TYPE_RELOCATE_CLOSE);manager.fireEvent('close',element);});},_relocateActiveNotifications:function(sourceEvent){var base=this._applyScrollPosition(this.options.locationVBase);for(var index=0;index<this.elements.length;index++){var el=this.elements[index];if(el.retrieve('working')){if(this.TYPE_RELOCATE_CLOSE==sourceEvent){el.retrieve('baseTween').start(base);}else{el.retrieve('scrollTween').start(base);}
base+=el.getSize().y+this.options.notificationsMargin;}}},_checkSize:function(element){var notificationElHeight=element.getStyle('height').toInt();var titleHeight=element.getElement('span.shotimootitle').getSize().y;var messageHeight=element.getElement('div.shotimoomessage').getSize().y;if(messageHeight>(notificationElHeight-titleHeight)){element.setStyle('height',notificationElHeight+(messageHeight-(notificationElHeight-titleHeight)));}},_resetNotificationElement:function(element){element.store('working',false);element.setStyle(this.options.locationVType,this.options.locationVBase);element.setStyle('height',this.options.height);element.setStyle('width',this.options.width);},_applyScrollPosition:function(base){if(this.options.locationVType=='top'){base+=this.options.parent.getScroll().y;}else{base-=this.options.parent.getScroll().y;}
return base;},TYPE_RELOCATE_CLOSE:1,TYPE_RELOCATE_SCROLL:2});